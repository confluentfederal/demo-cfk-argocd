{{- if .Values.ksqldb.queries.enabled }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ksqldb-queries
  namespace: {{ include "confluent-platform.namespace" . }}
  labels:
    {{- include "confluent-platform.labels" . | nindent 4 }}
data:
  {{- range $name, $query := .Values.ksqldb.queries.items }}
  {{ $name }}: |
    {{- $query | nindent 4 }}
  {{- end }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: ksqldb-query-init
  namespace: {{ include "confluent-platform.namespace" . }}
  labels:
    {{- include "confluent-platform.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: ksqldb-init
          image: curlimages/curl:latest
          command:
            - /bin/sh
            - -c
            - |
              echo "Waiting for ksqlDB to be ready..."
              until curl -s http://ksqldb.{{ include "confluent-platform.namespace" . }}.svc.cluster.local:8088/info > /dev/null 2>&1; do
                echo "ksqlDB not ready, waiting..."
                sleep 10
              done
              echo "ksqlDB is ready, applying queries..."
              
              # Apply each query file
              for query_file in /queries/*.sql; do
                echo "Applying $query_file..."
                query=$(cat "$query_file")
                curl -X POST http://ksqldb.{{ include "confluent-platform.namespace" . }}.svc.cluster.local:8088/ksql \
                  -H "Content-Type: application/vnd.ksql.v1+json" \
                  -d "{\"ksql\": \"$query\", \"streamsProperties\": {}}" || true
                sleep 2
              done
              echo "All queries applied!"
          volumeMounts:
            - name: queries
              mountPath: /queries
      volumes:
        - name: queries
          configMap:
            name: ksqldb-queries
{{- end }}
